#!/bin/bash
#
# This script runs tail -f on the given input files and
# sends the output to a given/ network port

DEFAULT_PORT=50000

usage () {
echo "$(basename "$0") [-h] [-p PORT] <files> -- Continuously send file content to network port

Options:
    -h  show this help text
    -p  network port (default: $DEFAULT_PORT)
    <files> files to use"
exit
}

# Call usage if too few arguments are supplied
[[ $# -lt 1 ]] && usage

# Parse arguments
while [[ $# -gt 0 ]]; do
    opt="$1"
    case $opt in
        -h)
            usage
            ;;
        -p)
            port="$2"
            shift
            ;;
        *)
            files="$@"
            break
            ;;
    esac
    shift
done

# Files cannot be empty
if [ "$files" == "" ]; then
    echo "No files given"
    usage
fi
# Set port
port=${port:-$DEFAULT_PORT}

echo "Starting $(basename "$0")"
echo "Using network port: $port"
echo "Using files: $files"


(tail -n 1 -f $files | nc localhost $port ) &

# kill the tail on sigterm/sigint
trap "echo 'Received SIGTERM/SIGINT - exiting'; echo 'EOF' | ncat localhost $port; jobs -p | xargs -n1 kill" SIGTERM SIGINT

wait
